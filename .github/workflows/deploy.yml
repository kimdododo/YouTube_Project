name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - 'cloudbuild.yaml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: yt-backend
  REGION: asia-northeast3
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  deploy:
    name: Build and Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write # OIDC ì¸ì¦ìš©

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Secrets
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "âŒ GCP_PROJECT_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ GCP_SA_KEY secret is not set"
            exit 1
          fi
          echo "âœ… Secrets are set"
          echo "Project ID: ${{ secrets.GCP_PROJECT_ID }}"
          echo "Service Account Key length: ${#GCP_SA_KEY}"

      - name: ðŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ðŸ”§ Configure Docker for GCR
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet

      - name: ðŸš€ Submit build to Cloud Build
        id: build
        run: |
          echo "Starting Cloud Build..."
          
          # SHORT_SHA ìƒì„± (ì»¤ë°‹ í•´ì‹œì˜ ì²˜ìŒ 7ìžë¦¬)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Commit SHA: ${{ github.sha }}"
          echo "Short SHA: $SHORT_SHA"
          
          # Cloud Build íŠ¸ë¦¬ê±° ì‹¤í–‰
          # ì£¼ì˜: substitution í‚¤ëŠ” _ë¡œ ì‹œìž‘í•˜ëŠ” ì»¤ìŠ¤í…€ ë³€ìˆ˜ë§Œ ê°€ëŠ¥
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --region=${{ env.REGION }} \
            --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},_REGION=${{ env.REGION }},_SHORT_SHA=$SHORT_SHA \
            --project=${{ env.PROJECT_ID }}
          
          echo "âœ… Build completed successfully"

      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status**: Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check Cloud Build logs for details:" >> $GITHUB_STEP_SUMMARY
            echo "https://console.cloud.google.com/cloud-build/builds?project=${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          fi

