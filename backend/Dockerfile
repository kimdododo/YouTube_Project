FROM python:3.11-slim

WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# Python ìºì‹œ ì œê±° (ë°°í¬ëœ ì´ë¯¸ì§€ì—ì„œ ì´ì „ ë²„ì „ì˜ .pyc íŒŒì¼ì´ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìžˆìŒ)
RUN find . -type d -name __pycache__ -exec rm -r {} + 2>/dev/null || true
RUN find . -type f -name "*.pyc" -delete 2>/dev/null || true
RUN find . -type f -name "*.pyo" -delete 2>/dev/null || true

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸
RUN echo "Dockerfile: Backend ready" > /tmp/backend_ready.txt

# Cloud Runì€ PORT í™˜ê²½ ë³€ìˆ˜ë¥¼ ì œê³µí•˜ë¯€ë¡œ ì´ë¥¼ ì‚¬ìš©
# í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ (reload ì œê±°)
ENV PORT=8080
ENV PYTHONPATH=/app
EXPOSE 8080

# ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ + ì„œë²„ ì‹œìž‘)
RUN echo '#!/bin/bash\n\
set -euo pipefail\n\
export PYTHONPATH=/app\n\
echo "=== Backend Startup Script ==="\n\
echo "Timestamp: $(date)"\n\
echo "[DEBUG] Environment variables:"\n\
echo "  DB_HOST=${DB_HOST:-not set}"\n\
echo "  DB_USER=${DB_USER:-not set}"\n\
echo "  DB_NAME=${DB_NAME:-not set}"\n\
echo "  DB_PORT=${DB_PORT:-not set}"\n\
echo "  DB_PASSWORD=${DB_PASSWORD:+***set***}"\n\
echo "  PORT=${PORT:-8080}"\n\
echo "  PYTHONPATH=${PYTHONPATH}"\n\
echo "  BENTO_BASE_URL=${BENTO_BASE_URL:-not set}"\n\
cd /app || { echo "âŒ Failed to cd to /app"; exit 1; }\n\
echo "Current directory: $(pwd)"\n\
echo "Python version: $(python --version)"\n\
echo "Uvicorn location: $(which uvicorn || echo not found)"\n\
echo "Testing Python imports..."\n\
python -c "import sys; print(f\"Python path: {sys.path}\")" || { echo "âš ï¸ Python path check failed"; }\n\
python -c "import app.main; print(\"âœ… app.main imported successfully\")" || { echo "âŒ Failed to import app.main"; python -c "import traceback; traceback.print_exc()"; exit 1; }\n\
echo "Testing critical dependencies..."\n\
python -c "import httpx; print(\"âœ… httpx imported\")" || { echo "âŒ httpx not found"; exit 1; }\n\
python -c "import fastapi; print(\"âœ… fastapi imported\")" || { echo "âŒ fastapi not found"; exit 1; }\n\
python -c "import uvicorn; print(\"âœ… uvicorn imported\")" || { echo "âŒ uvicorn not found"; exit 1; }\n\
echo "Running database migrations..."\n\
MIGRATION_START=$(date +%s)\n\
# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (íƒ€ìž„ì•„ì›ƒ ì—†ì´, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)\n\
if timeout 60 alembic upgrade head 2>&1; then\n\
  MIGRATION_END=$(date +%s)\n\
  MIGRATION_DURATION=$((MIGRATION_END - MIGRATION_START))\n\
  echo "âœ… Database migrations completed successfully in ${MIGRATION_DURATION}s"\n\
else\n\
  MIGRATION_EXIT_CODE=$?\n\
  MIGRATION_END=$(date +%s)\n\
  MIGRATION_DURATION=$((MIGRATION_END - MIGRATION_START))\n\
  echo "âš ï¸ Migration failed after ${MIGRATION_DURATION}s (exit code: $MIGRATION_EXIT_CODE)"\n\
  echo "âš ï¸ Continuing with server start despite migration failure..."\n\
fi\n\
PORT=${PORT:-8080}\n\
echo "Starting FastAPI server on port ${PORT}..."\n\
echo "Server start time: $(date)"\n\
echo "PORT environment variable: ${PORT}"\n\
echo "Testing port binding..."\n\
python -c "import socket; s = socket.socket(); s.bind((\"0.0.0.0\", ${PORT})); s.close(); print(f\"âœ… Port ${PORT} is available\")" || { echo "âŒ Port ${PORT} is not available"; exit 1; }\n\
# Cloud Runì´ PORT í™˜ê²½ ë³€ìˆ˜ë¥¼ ì œê³µí•˜ë¯€ë¡œ ë°˜ë“œì‹œ ì‚¬ìš©\n\
# Pythonìœ¼ë¡œ ì§ì ‘ ì‹¤í–‰í•˜ì—¬ ë” ë‚˜ì€ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸\n\
echo "ðŸš€ Launching uvicorn..."\n\
exec python -m uvicorn app.main:app --host 0.0.0.0 --port ${PORT} --timeout-keep-alive 30 --log-level info --access-log --no-use-colors\n\
' > /app/start.sh && chmod +x /app/start.sh

CMD ["/app/start.sh"]

